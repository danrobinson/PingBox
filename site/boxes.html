<html>
  <head>
    <title>Creating Boxes</title>
    <script src="https://fb.me/react-0.13.2.js"></script>
    <script src="https://fb.me/JSXTransformer-0.13.2.js"></script>
    <script src="https://www.parsecdn.com/js/parse-latest.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  </head>
  <body>
    <div id="content"></div>

    <script type="text/jsx">

    // set up global Parse app
    var pingApp = pingApp || {};

    // set up Parse
    Parse.initialize("8fhsO5d7WTt6c7ffpVrPpHTVvuAi6vArrciyt8cK", "1GHMsEbKTKr7ZhLqcJUPcOJdi7CLD1YZeT4hGuEv");


    (function() {
    	"use strict";

    	// Collections

     	var TaskClass = Parse.Object.extend("Task", {
     		ping: function() {
     			Parse.Cloud.run('ping', {taskID: this.id}, {
     				success: function(result) {
     					
     				}
     				error: function(error) {

     				}
     			});
     		}
     	});
	    var TaskCollection = Parse.Collection.extend({
	  		model: TaskClass,
	   		query: new Parse.Query("Task")
			});

     	var PingClass = Parse.Object.extend("Ping", {});
	    var PingCollection = Parse.Collection.extend({
	  		model: PingClass,
	   		query: new Parse.Query("Task")
			});

			var tasks = new TaskCollection;
			tasks.on('add remove change sync', function(collection) {console.log("Task Event: ", collection)})
			tasks.fetch();
			var pings = new PingCollection;

			// Components

			var CollectionMixin = {
				componentDidMount: function () {
					// Whenever there may be a change in the data, trigger a
					// reconcile.
					this.getCollections().forEach(function (collection) {
						collection.on('add remove change sync', this.forceUpdate.bind(this, null));
					}, this);
				},

				componentWillUnmount: function () {
					this.getCollections().forEach(function (collection) {
						collection.off(null, null, this);
					}, this);
				}
			};

	    var PingButton = React.createClass({
	    	render: function() {
	    		if (!this.props.task.pinged) {
		    		return (
		    			<button onClick={this.props.handlePing}>Ping</button>
		    		)    			
	    		} else {
	 	    		return (
		    			<span>Pinged</span>
		    		)
	    		}
	    	}
	    });

	    var PingTaskRow = React.createClass({
				handlePing: function(event) {
					this.props.task.ping();
				},

				render: function() {
					var task = this.props.task;
					return (
						<tr>
							<td>{task.get("score")}</td>
							<td>{task.get("title")}</td>
							<td>{task.get("assignee")}</td>
							<td><PingButton task={task} handlePing={this.handlePing} /></td>
						</tr>	
					)
				}
	    });

	    var PingTopBox = React.createClass({
	    	mixins: [CollectionMixin],

				getCollections: function () {
					return [this.props.tasks];
				},

				render: function() {
					// var tasks = this.data.tasks;				
					return (
						<table>
							{
								this.props.tasks.map(function(task) {
									return <PingTaskRow key={task.id} task={task} />
								})
							}
						</table>
					)
				}
			});

			// Render Components

			var topBox = React.render(
	  		<PingTopBox tasks={tasks} />,
	  		$("#content")[0]
			);

	    // Add Variables To App Namespace
			pingApp.topBox = topBox;
			pingApp.tasks = tasks;
			pingApp.pings = pings;

		})();

   	/*

   	var user = new Parse.User();
		user.set("username", "danrobinson010");
		user.set("password", "ping12345");
		user.set("email", "dev.pingbox@gmail.com");

		user.signUp(null, {
		  success: function(user) {
		    // Hooray! Let them use the app now.
		  },
		  error: function(user, error) {
		    // Show the error message somewhere and let the user try again.
		    alert("Error: " + error.code + " " + error.message);
		  }
		});

		

   	query.find({
   		success: function(tasks) {
   			

   			Parse.Object.destroyAll(tasks).then(function() {
				 // ACL to restrict write to user, and public read access
				var custom_acl = new Parse.ACL();
				custom_acl.setPublicReadAccess(true);
				custom_acl.setPublicWriteAccess(true); 
		    var tasks = [
		    	new Task({
		    		title: "Build Outlook extension",
		    		assignee: "Chris",
		    		score: 3,
		    		pinged: false,
		    	}),
		    	new Task({
		    		title: "Build web interface",
		    		assignee: "Dan",
		    		score: 3,
		    		pinged: false,
		    	}),
		    	new Task({
		    		title: "Build backend",
		    		assignee: "Nathan",
		    		score: 2,
		    		pinged: false,
		    	}),    	
		    ];

		    for (i=0; i<tasks.length; i++) {
		    	tasks[i].set("pinged", false);
		    	tasks[i].save()
		    }
		  }
   	});

		*/

    </script>
  </body>
</html>
